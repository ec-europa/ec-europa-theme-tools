<?php
/**
 * @file
 * Nexteuropa inline page navigation.
 */

define('NEXTEUROPA_INPAGE_NAV_DEPTH', 'h2');

global $_nexteuropa_inpage_nav_headings_;

/**
 * Implements hook_init().
 */
function nexteuropa_inpage_nav_init() {
  global $_nexteuropa_inpage_nav_headings_;
  if ($node = menu_get_object('node')) {
    node_build_content($node);
    $content = $node->content;
    unset($content['in_page_navigation']);
    $html = drupal_render($content);
    $_nexteuropa_inpage_nav_headings_ = _nexteuropa_inpage_nav_markup_anchor($html);
  }
}

/**
 * Implements hook_block_info().
 */
function nexteuropa_inpage_nav_block_info() {
  $blocks = array();
  $blocks['inline_navigation']['info'] = t('In-page Navigation');
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function nexteuropa_inpage_nav_block_view($delta = '') {
  global $_nexteuropa_inpage_nav_headings_;
  $block = array();

  if ($delta === "inline_navigation") {
    $block['content'] = array();
    $items = array();

    if (empty($_nexteuropa_inpage_nav_headings_) || !($node = menu_get_object('node'))) {

      return $block;
    }

    foreach ($_nexteuropa_inpage_nav_headings_ as $heading) {
      $items[] = '<a href="#' . $heading['id'] . '" class="inpage_nav__list-item">' . $heading['label'] . '</a>';
    }

    // Include js.
    drupal_add_js(drupal_get_path('module', 'nexteuropa_inpage_nav') . '/js/inpage_nav.js');
    drupal_add_js(array('inpage_navigation' => array('node_title' => $node->title)), 'setting');

    $block['subject'] = t('Page Contents');
    $variables = array(
      'items' => $items,
      'attributes' => array(
        'class' => 'nav inpage-nav__list',
      ),
    );
    $block['content'] = '<div class="inpage-nav is-scrollspy-target">' . theme('item_list', $variables) . '</div>';
  }

  return $block;
}

/**
 * Helper: returns the list of heading anchors in the markup.
 */
function _nexteuropa_inpage_nav_markup_anchor($markup) {
  $pattern = "/<" . NEXTEUROPA_INPAGE_NAV_DEPTH . ".*?id=\"(.[^\"]*)\".*?>(.[^\<]*)<\/" . NEXTEUROPA_INPAGE_NAV_DEPTH . ">/";
  preg_match_all($pattern, $markup, $matches);
  $anchors = array();
  foreach ($matches[1] as $i => $id) {
    $anchors[] = array(
      'id' => $id,
      'label' => $matches[2][$i],
    );
  }
  return $anchors;
}

/**
 * Implements hook_theme().
 *
 * Used to wrap the items in a specific class BEM way.
 */
function nexteuropa_inpage_nav_theme() {
  return array(
    'inpage_nav_block' => array(
      'template' => "templates/" . 'inpage_nav_block',
      'vars' => NULL,
    ),
  );
}
